name: AqualinkD build Workflow
on:
  # The push triggers are currently commented out to focus on manual runs
  #push:
  #  branches: [ main ]
  #  tags:
  #    - 'v*.*.*'
  workflow_dispatch: # Allow manual run
    inputs:
      simulate_tag_release:
        description: 'Simulate a formal tag release (e.g., v2.11) to create a final, published release.'
        type: boolean
        required: true
        default: false
      tag_name_to_use:
        description: 'If simulating a tag release, provide the tag name (e.g., v2.11). Required if simulating.'
        type: string
        required: false

jobs:
  build_and_deploy:
    # Use the standard runner, the container handles the x86-64 to cross-compile setup
    runs-on: ubuntu-latest 

    # --- JOB-LEVEL CONTAINER DEFINITION ---
    # This runs the entire job inside the Debian environment, making all 'run' steps clean.
    container:
      image: debian:bullseye 
      
    steps:
    # 1. Checkout the source code (this runs INSIDE the container and populates /github/workspace)
    - uses: actions/checkout@v4
      with:
        # CORRECTED: Reverting to the supported short-circuit logic: (Condition && TrueValue) || FalseValue
        # This checks out the input tag if the simulation condition is fully met, otherwise it uses github.ref.
        ref: ${{ (github.event_name == 'workflow_dispatch' && fromJSON(github.event.inputs.simulate_tag_release) && github.event.inputs.tag_name_to_use != '') && github.event.inputs.tag_name_to_use || github.ref }}
    
    # --- NEW STEP: Display Checked-Out Version/Tag ---
    - name: Display Checked-Out Version
      run: |
        echo "--- Workflow Context ---"
        # github.ref_name is the branch name or tag name (e.g., 'main' or 'v2.11')
        echo "Checked out Reference Name (Branch/Tag): ${{ github.ref_name }}"
        # github.ref is the full Git reference (e.g., 'refs/heads/main' or 'refs/tags/v2.11')
        echo "Full GitHub Reference: ${{ github.ref }}"
        echo "--- Starting Build ---"
    
    # 2. Optimized Cross-Compile step
    - name: Setup build environment for ARM64 and ARMHF
      # Using a standard 'run' block as we are already inside the container
      run: |
        # Enable cross-architectures
        dpkg --add-architecture armhf 
        dpkg --add-architecture arm64
        
        # Update and Install ALL dependencies (APT requires update after add-architecture)
        apt-get update -y
        apt-get install -y \
          build-essential \
          crossbuild-essential-armhf \
          crossbuild-essential-arm64 \
          libsystemd-dev \
          libsystemd-dev:arm64 \
          libsystemd-dev:armhf
        
    - name: Compile AqualinkD
      # Using a standard 'run' block as we are already inside the container
      run: |
        make clean && \
        make buildrelease

    # The remaining steps automatically run inside the container as well

    - name: Create release archive
      # This step correctly archives both resulting binaries from the workspace
      run: tar -czvf aqualinkd-build.tar.gz web/ release/

    # --- Step 1: Create/Update the Draft Development Release ---
    # Condition Logic: Run if it's a 'push' on 'main' AND NOT a tag, OR if it's a manual run AND NOT simulating a tag.
    - name: Create or Update GitHub Draft Release
      if: |
        ${{ 
          (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) 
          || (github.event_name == 'workflow_dispatch' && !fromJSON(github.event.inputs.simulate_tag_release))
        }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        tag_name: development-latest 
        name: Development Build (Latest Main/Manual)
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # --- Step 2: Create the Formal Versioned Release ---
    # Condition Logic: Run if it's a tag push, OR if it's a manual run AND IS simulating a tag 
    # AND the required tag name input is NOT empty.
    - name: Create Final GitHub Release
      if: |
        ${{ 
          startsWith(github.ref, 'refs/tags/') 
          || (github.event_name == 'workflow_dispatch' 
              && fromJSON(github.event.inputs.simulate_tag_release)
              && github.event.inputs.tag_name_to_use != ''
          )
        }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        # This will now safely use the provided input or the actual tag name
        tag_name: ${{ github.event.inputs.tag_name_to_use || github.ref_name }}
        name: AqualinkD Release ${{ github.event.inputs.tag_name_to_use || github.ref_name }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}