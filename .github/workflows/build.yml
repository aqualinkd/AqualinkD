name: AqualinkD build Workflow
on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch: # Allow manual run

jobs:
  build_and_deploy:
    # Using standard x86-64 runner for cross-compilation
    runs-on: ubuntu-22.04 
    
    steps:
    - uses: actions/checkout@v4
    
    # CONSOLIDATED STEP FOR DUAL-ARCH BUILD (ARM64 & ARMHF)
    - name: Compile AqualinkD for ARM64 and ARMHF inside Debian Container
      # Using the official 64-bit ARM Debian image
      uses: docker://arm64v8/debian:bullseye 
      with:
        entrypoint: /bin/bash
        args: -c "
          # 1. Change to the workspace directory
          cd /github/workspace && 

          # 2. Enable 32-bit (armhf) architecture
          dpkg --add-architecture armhf && 

          # 3. Update and Install ALL build dependencies:
          apt-get update -y && 
          apt-get install -y build-essential crossbuild-essential-armhf libsystemd-dev libsystemd-dev:armhf && 

          # --- 4. RUN SINGLE COMPILATION COMMAND ---
          # Assuming 'make buildrelease' now handles the dual-architecture build
          # and produces: release/aqualinkd_arm64 and release/aqualinkd_armhf
          echo '--- Starting Unified Dual-Arch Build (ARM64 & ARMHF) ---' &&
          make clean && 
          make buildrelease
        "

    - name: Create release archive
      # This step correctly archives both resulting binaries from the workspace
      run: tar -czvf aqualinkd-build.tar.gz web/ release/aqualinkd_arm64 release/aqualinkd_armhf

    # --- Step 1: Create/Update the Draft Development Release ---
    - name: Create or Update GitHub Draft Release
      if: |
        ${{ 
          github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') 
          || github.event_name == 'workflow_dispatch' 
        }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        tag_name: development-latest 
        name: Development Build (Latest Main/Manual)
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # --- Step 2: Create the Formal Versioned Release ---
    - name: Create Final GitHub Release
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        tag_name: ${{ github.ref_name }}
        name: AqualinkD Release ${{ github.ref_name }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}