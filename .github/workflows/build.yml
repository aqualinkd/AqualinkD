

name: AqualinkD build Workflow
on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch: # Allow manual run

jobs:
  build_and_deploy:
    runs-on: ubuntu-22.04-arm 
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build tools and compile
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential crossbuild-essential-armhf libsystemd-dev:arm64
        sudo dpkg --add-architecture armhf
        sudo apt-get update
        sudo apt install libsystemd-dev:armhf
        make buildrelease 
    - name: Create release archive
      run: tar -czvf aqualinkd-build.tar.gz web/ release/
    # --- Step 1: Create/Update the Draft Development Release (Runs ONLY on main branch push) ---
    - name: Create or Update GitHub Draft Release
      if: ${{ github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/') }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        # Static name and tag for the continuous draft
        tag_name: development-latest 
        name: Development Build (Latest Main)
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # --- Step 2: Create the Formal Versioned Release (Runs ONLY on tag push) ---
    - name: Create Final GitHub Release
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      uses: softprops/action-gh-release@v2 
      with:
        files: aqualinkd-build.tar.gz
        overwrite: true
        # Dynamic name and tag derived from the pushed Git tag
        tag_name: ${{ github.ref_name }}
        name: AqualinkD Release ${{ github.ref_name }}
        draft: false # Publish immediately
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
